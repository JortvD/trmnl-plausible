<div class="layout layout--row gap--space-between">
  <div class="grid">
    <div class="col">
      <!-- Chart (3 columns) -->
      <div id="chart-8513af80da0f" data-highcharts-chart="0" style="overflow: hidden;"></div>
      <div class="grid mt--4">

        {% assign metrics = trmnl.plugin_settings.custom_fields_values.metric %}
        {% assign chart_for = trmnl.plugin_settings.custom_fields_values.chart_for | plus: 0 %}
        {% assign main_metric = metrics[chart_for] %}

        <!-- Main metric + first up to 3 non-main metrics (2nd column) -->
        <div class="item col--span-1">
          <div class="meta"></div>
          <div class="content">
            <span class="value value--large value--tnums" id="sum-value-{{ main_metric }}"></span>
            <span class="label" id="label-{{ main_metric }}"></span>

            {% assign shown = 0 %}
            {% for metric in metrics %}
              {% if metric != main_metric and shown < 2 %}
                <span class="value value--xsmall value--tnums" id="sum-value-{{ metric }}"></span>
                <span class="label" id="label-{{ metric }}"></span>
                {% assign shown = shown | plus: 1 %}
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <!-- Date + any remaining (max 2) non-main metrics (3rd column) -->
        <div class="item col--span-1">
          <div class="meta"></div>
          <div class="content">
            {% assign shown = 0 %}
            {% for metric in metrics %}
              {% if metric != main_metric %}
                {% if shown >= 2 and shown < 5 %}
                  <span class="value value--xsmall value--tnums" id="sum-value-{{ metric }}"></span>
                  <span class="label" id="label-{{ metric }}"></span>
                {% endif %}
                {% assign shown = shown | plus: 1 %}
              {% endif %}
            {% endfor %}

            <span class="value value--xsmall value--tnums" data-value-type="date">
              <div class="w--14 h--1.5 mb--1 mt--1 bg--black" style="border-radius: 20px;"></div>
              <span id="min-date" class="label"></span>-<span id="max-date" class="label"></span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>

  <script type="text/javascript">
    // --- Metric map (labels, units, aggregation) ---
    const METRIC_META = {
      visitors:       { label: 'Visitors',          agg: 'sum',           unit: ''  },
      visits:         { label: 'Visits',            agg: 'sum',           unit: ''  },
      pageviews:      { label: 'Pageviews',         agg: 'sum',           unit: ''  },
      events:         { label: 'Events',            agg: 'sum',           unit: ''  },
      bounce_rate:    { label: 'Bounce rate',       agg: 'weighted_avg',  unit: '%', weight_by: 'pageviews' },
      visit_duration: { label: 'Visit duration',    agg: 'weighted_avg',  unit: 's', weight_by: 'visitors'  }
    };

    // Helpers
    function prettify(id){ return id.replace(/_/g,' ').replace(/\b\w/g,s=>s.toUpperCase()); }
    function labelFor(metric){ const meta=METRIC_META[metric]||{}; return meta.label||prettify(metric); }
    function inferredUnit(metric,metaUnit){
      if(metaUnit) return metaUnit;
      if(/_rate$/i.test(metric)) return '%';
      if(/duration|time|seconds/i.test(metric)) return 's';
      return '';
    }
    function formatMetricValue(metric,value){
      const unit=inferredUnit(metric,(METRIC_META[metric]||{}).unit);
      if(unit==='%' ) return `${(value||0).toFixed(2)}%`;
      if(unit==='s') return `${Math.round(value||0).toLocaleString('en-US')}s`;
      return Math.round(value||0).toLocaleString('en-US');
    }
    function valuePerMetric(metric,index,data,metricsList){
      const meta=METRIC_META[metric]||{agg:'sum'};
      if(meta.agg==='sum'){
        return data.reduce((acc,item)=>acc+(item.metrics[index]||0),0);
      }
      if(meta.agg==='avg'){
        const vals=data.map(item=>item.metrics[index]||0);
        const sum=vals.reduce((a,b)=>a+b,0);
        return vals.length?sum/vals.length:0;
      }
      if(meta.agg==='weighted_avg'){
        const wIdx=meta.weight_by?metricsList.indexOf(meta.weight_by):-1;
        const pairs=data.map(item=>({v:item.metrics[index]||0,w:wIdx>=0?(item.metrics[wIdx]||0):1}));
        const wSum=pairs.reduce((a,p)=>a+p.v*p.w,0);
        const tW=pairs.reduce((a,p)=>a+p.w,0);
        return tW?wSum/tW:0;
      }
      return data.reduce((acc,item)=>acc+(item.metrics[index]||0),0);
    }
    function reformatResults(results,metricIndex){
      return results.map(item=>[item.dimensions[0], item.metrics[metricIndex]]);
    }

    // Data from template
    let data     = {{ results | json }};
    let metrics  = {{ trmnl.plugin_settings.custom_fields_values.metric | json }};
    let chartFor = {{ chart_for | json }};
    let mainMetric = metrics[chartFor];
    let queryObj = {{ query | json }};
    let groupBy  = (queryObj.dimensions && queryObj.dimensions[0]) || '';
    const groupPrefix = (groupBy||'').toLowerCase();
    const isTimeQuery  = groupPrefix.startsWith('time');
    const isVisitQuery = groupPrefix.startsWith('visit');

    // Fill labels
    metrics.forEach((metric)=>{
      const el=document.getElementById('label-'+metric);
      if(el) el.innerText=labelFor(metric);
    });

    // Fill values
    metrics.forEach((metric,i)=>{
      const el=document.getElementById('sum-value-'+metric);
      if(!el) return;
      const value=valuePerMetric(metric,i,data,metrics);
      el.innerText=formatMetricValue(metric,value);
    });

    // Date range
    if(isTimeQuery){
      let minDate=Math.min(...data.map(item=>new Date(item.dimensions[0]).getTime()));
      let maxDate=Math.max(...data.map(item=>new Date(item.dimensions[0]).getTime()));
      document.getElementById('min-date').innerText=new Date(minDate).toLocaleDateString('en-US',{month:'short',day:'numeric'});
      document.getElementById('max-date').innerText=new Date(maxDate).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    }else{
      let minDate=queryObj.date_range && queryObj.date_range[0];
      let maxDate=queryObj.date_range && queryObj.date_range[1];
      if(minDate&&maxDate){
        document.getElementById('min-date').innerText=new Date(minDate).toLocaleDateString('en-US',{month:'short',day:'numeric'});
        document.getElementById('max-date').innerText=new Date(maxDate).toLocaleDateString('en-US',{month:'short',day:'numeric'});
      }
    }

    // Chart config
    const chartType = isVisitQuery ? 'column' : 'spline';
    let chart_data = isTimeQuery
      ? reformatResults(data, chartFor)
      : data.map(item => [String(item.dimensions[0]), item.metrics[chartFor]]);

    const xAxisConfig = isTimeQuery ? {
      type:'datetime',
      labels:{ style:{ fontSize:'16px', color:'#000000' }, padding:5, y:25 },
      lineWidth:0, gridLineDashStyle:'dot', tickWidth:1, tickLength:0,
      gridLineWidth:1, gridLineColor:'#000000', tickPixelInterval:120,
      offset:0, margin:0, title:{ text:null }
    } : {
      type:'category',
      labels:{ style:{ fontSize:'16px', color:'#000000' } },
      lineWidth:0, gridLineDashStyle:'dot', tickLength:0,
      gridLineWidth:1, gridLineColor:'#000000', title:{ text:null }
    };

    Highcharts.chart('chart-8513af80da0f',{
      chart:{ type:chartType, height:200, width:null, animation:false, spacing:[5,10,0,10] },
      title:{ text:null },
      plotOptions:{
        series:{ animation:false, enableMouseTracking:false, states:{ hover:{ enabled:false } }, marker:{ enabled:false } },
        column:{ pointPadding:0.1, borderWidth:0 }
      },
      series:[{ data:chart_data, lineWidth:4, color:'#000000', name:labelFor(mainMetric), zIndex:2 }],
      tooltip:{ enabled:false }, legend:{ enabled:false },
      yAxis:{ labels:{ style:{ fontSize:'16px', color:'#000000' } }, gridLineDashStyle:'shortdot', gridLineWidth:1, gridLineColor:'#000000', tickAmount:5, title:{ text:null } },
      xAxis:xAxisConfig,
      credits:{ enabled:false }
    });
  </script>
</div>

<div class="title_bar">
   <svg class="image" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 60 60"><g id="Plausible_-_Branding"><g id="Symbol_-_Purple_Gradient"><path class="cls-1" d="M45.2456059,22.6027536c-1.0911024,10.4557623-10.2327486,18.2272825-20.7452872,18.2272807h-4.047804v9.570007c0,5.3019285-4.2980623,9.5999908-9.5999908,9.5999908H3.3599854c-1.8556687,0-3.3599854-1.5043167-3.3599854-3.3599854v-19.7025146l5.0380685-7.0686343c.9118097-1.2793096,2.587965-1.7566996,4.0369945-1.1497867l2.8657142,1.2002785c1.4444817.6050081,3.1153774.12945,4.0247968-1.1455083l6.7172007-9.417163c.9071158-1.2717288,2.5743943-1.7450816,4.0144283-1.1397262l5.5198678,2.3204187c1.4430268.6066135,3.1137697.1319561,4.0223175-1.1427389l6.4594145-9.0625757c2.0248091,3.5597961,3.0145069,7.7887694,2.5468032,12.2706573Z"/><path class="cls-2" d="M3.2920959,28.8726296c.82329-1.1551271,2.0209115-2.0434967,3.4138697-2.3114381,1.0861554-.2089265,2.156905-.0992829,3.1472499.3155174l2.8649902,1.1999512c.1651001.0691528.3388672.104187.5164795.104187.4365845,0,.8488159-.2124634,1.1026611-.5683594l6.5942097-9.2447929c.8231505-1.154021,2.0204067-2.0410099,3.4124878-2.3083136,1.0821376-.2077892,2.1463585-.0989034,3.1282512.3138487l5.5198364,2.3204346c.1665649.0700684.3417969.1055298.5206909.1055298.4351807,0,.8456421-.2113647,1.0979614-.5653687l6.9192505-9.7077637C37.8272145,3.3644409,31.7802174,0,24.9450124,0H3.3599904C1.5043217,0,.000005,1.5043167.000005,3.3599854v30.1316528l3.2920909-4.6190085Z"/></g></g></svg>
  <span class="title">{{ trmnl.plugin_settings.instance_name }}</span>
  <span class="instance">{{ trmnl.plugin_settings.custom_fields_values.site_id }}</span>
</div>
