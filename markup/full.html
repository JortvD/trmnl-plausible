<div class="layout layout--col gap--space-between">
  <div class="grid">
    <div class="row p--4">
      <div class="grid">
        {% assign metrics = trmnl.plugin_settings.custom_fields_values.metric %}
        {% assign chart_for = trmnl.plugin_settings.custom_fields_values.chart_for | plus: 0 %}
        {% assign main_metric = metrics[chart_for] %}

        {%- comment -%} Determine the first non-main metric (if any) {%- endcomment -%}
        {% assign first_non_main_metric = nil %}
        {% for m in metrics %}
          {% if m != main_metric and first_non_main_metric == nil %}
            {% assign first_non_main_metric = m %}
          {% endif %}
        {% endfor %}

        <!-- Main metric -->
        <div class="item col--span-3">
          <div class="meta"></div>
          <div class="content">
            <span class="value value--large value--tnums" id="sum-value-{{ main_metric }}"></span>
            <span class="label" id="label-{{ main_metric }}"></span>
          </div>
        </div>

        {%- comment -%}
          Remaining non-main metrics in columns of up to two per column.
        {%- endcomment -%}
        {% assign pair_count = 0 %}
        {% for metric in metrics %}
          {% if metric != main_metric and metric != first_non_main_metric %}
            {% if pair_count == 0 %}
              <div class="item col--span-2">
                <div class="meta"></div>
                <div class="content">
            {% endif %}

                  <span class="value value--xsmall " id="sum-value-{{ metric }}"></span>
                  <span class="label" id="label-{{ metric }}"></span>

            {% assign pair_count = pair_count | plus: 1 %}
            {% if pair_count == 2 %}
                </div>
              </div>
              {% assign pair_count = 0 %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if pair_count == 1 %}
            </div>
          </div>
        {% endif %}

        <!-- First non-main metric ABOVE date range -->
        <div class="item col--span-2">
          <div class="meta"></div>
          <div class="content">
            {% if first_non_main_metric %}
              <span class="value value--xsmall" id="sum-value-{{ first_non_main_metric }}"></span>
              <span class="label" id="label-{{ first_non_main_metric }}"></span>
            {% endif %}
            <span class="value value--xsmall value--tnums" data-value-type="date">
              <div class="w--14 h--1.5 mb--1 mt--1 bg--black" style="border-radius: 20px;"></div>
              <span id="min-date" class="label"></span> - <span id="max-date" class="label"></span>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/highcharts-more.js"></script>
  <script src="https://usetrmnl.com/js/highcharts/12.3.0/pattern-fill.js"></script>

  <div id="chart-8513af80da0f" class="w--full" data-highcharts-chart="0" style="overflow: hidden;"></div>

  <script type="text/javascript">
    // --- Metric map (labels, units, aggregation) ---
    // Add more entries here if you introduce new metrics.
    const METRIC_META = {
      visitors:       { label: 'Visitors',          agg: 'sum',           unit: ''  },
      visits:         { label: 'Visits',            agg: 'sum',           unit: ''  },
      pageviews:      { label: 'Pageviews',         agg: 'sum',           unit: ''  },
      events:         { label: 'Events',            agg: 'sum',           unit: ''  },
      bounce_rate:    { label: 'Bounce rate',       agg: 'weighted_avg',  unit: '%',  weight_by: 'pageviews' },
      visit_duration: { label: 'Visit duration',    agg: 'weighted_avg',  unit: 's',  weight_by: 'visitors'  }
    };

    // Helpers
    function prettify(id) {
      return id.replace(/_/g, ' ').replace(/\b\w/g, s => s.toUpperCase());
    }
    function labelFor(metric) {
      const meta = METRIC_META[metric] || {};
      const base = meta.label || prettify(metric);
      return base;
    }
    function inferredUnit(metric, metaUnit) {
      if (metaUnit) return metaUnit;
      if (/_rate$/i.test(metric)) return '%';
      if (/duration|time|seconds/i.test(metric)) return 's';
      return '';
    }
    function formatMetricValue(metric, value) {
      const unit = inferredUnit(metric, (METRIC_META[metric] || {}).unit);
      if (unit === '%') return `${value.toFixed(2)}%`;
      if (unit === 's') return `${Math.round(value).toLocaleString('en-US')}s`;
      return Math.round(value).toLocaleString('en-US');
    }

    function valuePerMetric(metric, index, data, metricsList) {
      const meta = METRIC_META[metric] || { agg: 'sum' };

      if (meta.agg === 'sum') {
        return data.reduce((acc, item) => acc + item.metrics[index], 0);
      }

      if (meta.agg === 'avg') {
        const values = data.map(item => item.metrics[index]);
        const sum = values.reduce((a, b) => a + b, 0);
        return values.length ? sum / values.length : 0;
      }

      if (meta.agg === 'weighted_avg') {
        const weightIdx = meta.weight_by ? metricsList.indexOf(meta.weight_by) : -1;
        const pairs = data.map(item => ({
          v: item.metrics[index],
          w: weightIdx >= 0 ? item.metrics[weightIdx] : 1
        }));
        const weightedSum = pairs.reduce((a, p) => a + p.v * p.w, 0);
        const totalWeight = pairs.reduce((a, p) => a + p.w, 0);
        return totalWeight ? weightedSum / totalWeight : 0;
      }

      // Fallback
      return data.reduce((acc, item) => acc + item.metrics[index], 0);
    }

    function reformatResults(results, metricIndex) {
      return results.map(item => [
        item.dimensions[0],
        item.metrics[metricIndex]
      ]);
    }

    // Data from template
    let data = {{ results | json }};
    let metrics = {{ trmnl.plugin_settings.custom_fields_values.metric | json }};
    let chartFor = {{ chart_for | json }};
    let mainMetric = metrics[chartFor];

    // Fill metric labels
    metrics.forEach((metric) => {
      const el = document.getElementById('label-' + metric);
      if (el) el.innerText = labelFor(metric);
    });

    // Fill metric values
    metrics.forEach((metric, i) => {
      const el = document.getElementById('sum-value-' + metric);
      if (!el) return;
      const value = valuePerMetric(metric, i, data, metrics);
      el.innerText = formatMetricValue(metric, value);
    });

    // Date range
    let minDate = Math.min(...data.map(item => new Date(item.dimensions[0]).getTime()));
    let maxDate = Math.max(...data.map(item => new Date(item.dimensions[0]).getTime()));
    document.getElementById('min-date').innerText = new Date(minDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    document.getElementById('max-date').innerText = new Date(maxDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

    // Chart
    let chart_data = reformatResults(data, chartFor);
    Highcharts.chart('chart-8513af80da0f', {
      chart: { type: 'spline', width: null, animation: false, spacing: [10, 10, 5, 10] },
      title: { text: null },
      plotOptions: {
        series: {
          animation: false,
          enableMouseTracking: false,
          states: { hover: { enabled: false } },
          marker: { enabled: false }
        }
      },
      series: [{ data: chart_data, lineWidth: 4, color: '#000000', name: labelFor(mainMetric), zIndex: 2 }],
      tooltip: { enabled: false },
      legend: { enabled: false },
      yAxis: {
        labels: { style: { fontSize: '16px', color: '#000000' } },
        gridLineDashStyle: 'shortdot',
        gridLineWidth: 1,
        gridLineColor: '#000000',
        tickAmount: 5,
        title: { text: null }
      },
      xAxis: {
        type: 'datetime',
        labels: { style: { fontSize: '16px', color: '#000000' }, padding: 5, y: 25 },
        lineWidth: 0,
        gridLineDashStyle: 'dot',
        tickWidth: 1,
        tickLength: 0,
        gridLineWidth: 1,
        gridLineColor: '#000000',
        tickPixelInterval: 120,
        offset: 0,
        margin: 0,
        title: { text: null }
      },
      credits: { enabled: false }
    });
  </script>
</div>

<div class="title_bar">
  <img class="image" src="https://usetrmnl.com/images/plugins/trmnl--render.svg">
  <span class="title">{{ trmnl.plugin_settings.instance_name }}</span>
  <span class="instance">{{ trmnl.plugin_settings.custom_fields_values.site_id }}</span>
</div>
